<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>storage/sftp-remote.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Bucket.html">Bucket</a><ul class='methods'><li data-type='method'><a href="Bucket.html#addActor">addActor</a></li><li data-type='method'><a href="Bucket.html#create">create</a></li><li data-type='method'><a href="Bucket.html#exists">exists</a></li><li data-type='method'><a href="Bucket.html#file">file</a></li><li data-type='method'><a href="Bucket.html#getIndex">getIndex</a></li><li data-type='method'><a href="Bucket.html#getMetadata">getMetadata</a></li><li data-type='method'><a href="Bucket.html#indexFile">indexFile</a></li><li data-type='method'><a href="Bucket.html#open">open</a></li></ul></li><li><a href="File.html">File</a><ul class='methods'><li data-type='method'><a href="File.html#create">create</a></li><li data-type='method'><a href="File.html#exists">exists</a></li><li data-type='method'><a href="File.html#getLastchange">getLastchange</a></li><li data-type='method'><a href="File.html#getMetadata">getMetadata</a></li><li data-type='method'><a href="File.html#open">open</a></li><li data-type='method'><a href="File.html#read">read</a></li><li data-type='method'><a href="File.html#save">save</a></li></ul></li><li><a href="FsStorage.html">FsStorage</a><ul class='methods'><li data-type='method'><a href="FsStorage.html#fileExists">fileExists</a></li><li data-type='method'><a href="FsStorage.html#readDir">readDir</a></li><li data-type='method'><a href="FsStorage.html#readFile">readFile</a></li><li data-type='method'><a href="FsStorage.html#rmFile">rmFile</a></li><li data-type='method'><a href="FsStorage.html#start">start</a></li><li data-type='method'><a href="FsStorage.html#stop">stop</a></li><li data-type='method'><a href="FsStorage.html#touchDir">touchDir</a></li><li data-type='method'><a href="FsStorage.html#writeFile">writeFile</a></li></ul></li><li><a href="GCEStorage.html">GCEStorage</a><ul class='methods'><li data-type='method'><a href="GCEStorage.html#fileExists">fileExists</a></li><li data-type='method'><a href="GCEStorage.html#readDir">readDir</a></li><li data-type='method'><a href="GCEStorage.html#readFile">readFile</a></li><li data-type='method'><a href="GCEStorage.html#rmFile">rmFile</a></li><li data-type='method'><a href="GCEStorage.html#start">start</a></li><li data-type='method'><a href="GCEStorage.html#stop">stop</a></li><li data-type='method'><a href="GCEStorage.html#touchDir">touchDir</a></li><li data-type='method'><a href="GCEStorage.html#writeFile">writeFile</a></li></ul></li><li><a href="Gpgfs.html">Gpgfs</a><ul class='methods'><li data-type='method'><a href="Gpgfs.html#bucket">bucket</a></li><li data-type='method'><a href="Gpgfs.html#cacheWhoami">cacheWhoami</a></li><li data-type='method'><a href="Gpgfs.html#getBuckets">getBuckets</a></li><li data-type='method'><a href="Gpgfs.html#open">open</a></li></ul></li><li><a href="IStorage.html">IStorage</a><ul class='methods'><li data-type='method'><a href="IStorage.html#assertEnabled">assertEnabled</a></li><li data-type='method'><a href="IStorage.html#checksumFile">checksumFile</a></li><li data-type='method'><a href="IStorage.html#fileExists">fileExists</a></li><li data-type='method'><a href="IStorage.html#readDir">readDir</a></li><li data-type='method'><a href="IStorage.html#readFile">readFile</a></li><li data-type='method'><a href="IStorage.html#rmFile">rmFile</a></li><li data-type='method'><a href="IStorage.html#start">start</a></li><li data-type='method'><a href="IStorage.html#stop">stop</a></li><li data-type='method'><a href="IStorage.html#touchDir">touchDir</a></li><li data-type='method'><a href="IStorage.html#writeFile">writeFile</a></li></ul></li><li><a href="SFTPStorage.html">SFTPStorage</a><ul class='methods'><li data-type='method'><a href="SFTPStorage.html#fileExists">fileExists</a></li><li data-type='method'><a href="SFTPStorage.html#readDir">readDir</a></li><li data-type='method'><a href="SFTPStorage.html#readFile">readFile</a></li><li data-type='method'><a href="SFTPStorage.html#rmFile">rmFile</a></li><li data-type='method'><a href="SFTPStorage.html#start">start</a></li><li data-type='method'><a href="SFTPStorage.html#stop">stop</a></li><li data-type='method'><a href="SFTPStorage.html#touchDir">touchDir</a></li><li data-type='method'><a href="SFTPStorage.html#writeFile">writeFile</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#S_IFMT">S_IFMT</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">storage/sftp-remote.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const Path = require('path')
const {promisfy, waitFor} = require('promisfy')
const sanitize = require('sanitize-filename')
const debug = require('debug')('gpgfs.sftp-storage')

const SSHClient = require('ssh2').Client
const IStorage = require('../interface-storage')


/**
 * SFTP storage driver
 * @class
 * @implements IStorage
 */
class SFTPStorage extends IStorage {
  
  /*
   * @constructor
   * @param {Object} options 
   * @param {string} options.host               SSH host
   * @param {string} options.port               SSH port
   * @param {string} options.user               SSH user
   * @param {string} options.path               Remote fs path to root of gpgfs file system
   * @param {string} options.agent              Path to SSH agent socket
   * @param {Stream} options.stream             Already connected TCP stream
   * @param {string} options.privateKey         Private key text
   * @param {boolean} options.readOnly          Storage open mode
   */
  constructor({host, port, user, path, readOnly=false, stream=null, privateKey=null, agent=process.env.SSH_AUTH_SOCK}={}){
    super({readOnly})
    
    this.host = host
    this.port = port
    this.user = user
    this.agent = agent
    this.stream = stream
    this.privateKey = privateKey
    this.basePath = path || '.gpgfs/'
    
    this.sftp = null
    this.sftpFunc = {}
    this.connection = null
    this.isRelayClient = false
  }

  get name(){ return 'sftp' }
  
  async stop(){
    this.connection.end()
  }

  async openSftp(){
    debug('openSftp')
    if(this.sftp){ return }
    
    return new Promise((resolve, reject)=>{
      
      this.connection.sftp( (err, sftpClient)=>{
        if(err){ return reject(err) }
        
        debug('openSftp - ready')
        
        this.sftp = sftpClient
        

        this.sftpFunc = {
          stat: promisfy(this.sftp.stat, this.sftp),
          mkdir: promisfy(this.sftp.mkdir, this.sftp),
          unlink: promisfy(this.sftp.unlink, this.sftp),
          readdir: promisfy(this.sftp.readdir, this.sftp)
        }
        resolve()
      })
      
    })
  }

  async whileConnected(){
    return new Promise((resolve, reject)=>{
      this.connection.once('end', resolve)
    })
  }


  async start(){
    this.connection = new SSHClient()
    this.connection.once('ready', this.onReady.bind(this))

    let connect = new Promise((resolve,reject)=>{
      let resolved = false
      this.connection.once('ready', ()=>{
        debug('ready', 'connection open')
        this.privateKey=null
        if(!resolved){ resolved=true; resolve() }
      })

      this.connection.once('error', (err)=>{
        debug('error', err)
        this.privateKey=null
        if(!resolved){ resolved=true; reject(err.message) }
      })

      this.connection.once('end', ()=>{
        debug('end')
        this.privateKey=null
        if(!resolved){ resolved=true; reject(new Error('connection denied')) }
      })

    })

    try{

      const connConfig = {
        username: this.user,
        privateKey: this.privateKey,
        agent: this.privateKey ? null : this.agent,
        sock: this.stream,
        host: !this.stream ? this.host : null,
        port: !this.stream ? this.port : null
      }

      if(this.stream){ this.isRelayClient = true }

      this.connection.connect(connConfig)

    }
    catch(err){
      debug('caught err', err)
    }
    
    await connect
    await this.openSftp()
    debug('start',this.sftpFunc)
  }

  async onReady(){
    debug('authed and ready')
  }
  
  storagePath(path){
    return Path.normalize(
      this.basePath+"/" + Path.dirname(path) + '/'+ sanitize(Path.basename(path))
    )
  }

  get name(){ return 'sftp' }

  async fileExists(path=''){
    this.assertEnabled()
    const realPath = this.storagePath(path)
    
    try{
      const file = await this.sftpFunc.stat(realPath)
      
      debug('fileExists', file)
      
      if(!file){return false}
      
      return true
    }
    catch(err){
      debug('fileExists err')
      if(err.message == 'No such file'){ return false }
      
      throw err
    }
  }
  
  async readFile(path=''){
    this.assertEnabled()
    
    debug('readFile',path)
    if(!await this.fileExists(path)){ return }
    
    const realPath = this.storagePath(path)
    debug("downloading file: " + realPath)

    const fileStream = this.sftp.createReadStream(realPath, {
      flags: 'r',
      encoding: null,
      handle: null,
      mode: 0o666,
      autoClose: true
    })
    
    const content = await waitFor(fileStream, 'data')
    
    return content
  }

  async writeFile(path, data){
    this.assertEnabled()
    if(this.mode!=IStorage.MODE_WRITE){ throw new Error('read only') }
    
    const existance = await this.fileExists(path)
    
    const realPath = this.storagePath(path)
    debug("uploading file: " + realPath)
    const fileStream = this.sftp.createWriteStream(realPath, {
      flags: existance ? 'r+' : 'w',
      encoding: null,
      handle: null,
      mode: 0o666,
      autoClose: false
    })
    
    fileStream.end(data)
      
    debug('upload finished:', realPath)
  }

  async rmFile(path){ 
    this.assertEnabled()
    const realPath = this.storagePath(path)
    debug('rmFile -', realPath)
    
    await this.sftpFunc.unlink(realPath)
  }

  async readDir(path='.'){
    this.assertEnabled()
    
    const realPath = this.storagePath(path)
    debug('readdir', realPath)
    
    try{
      const files = await this.sftpFunc.readdir(realPath)

      const names = files.map( file => file.filename )

      return names
    }
    catch(err){
      if(err.message == 'No such file'){ return [] }
      
      throw err
    }
  }

  async dirExists(path){
    const files = await this.readDir(path)

    return (files.length > 0)
  }
  
 
  async touchDir(path=''){
    this.assertEnabled()
    
    const realPath = this.storagePath(path)
    debug('touch dir', realPath)
    const existance = await this.fileExists(path)
    
    if(!existance){
      debug('creating dir', realPath)
      
      const parentPath = path.split('/').slice(0, -1).join('/')
      
      if(this.storagePath(parentPath) != realPath){
        debug('parent', parentPath)
        await this.touchDir(parentPath)
      }
      
      await this.sftpFunc.mkdir(realPath)
    }
    
  }

}

module.exports = SFTPStorage
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.3</a> on Wed Feb 26 2020 18:12:46 GMT-0800 (Pacific Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
